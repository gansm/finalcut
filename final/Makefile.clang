#-----------------------------------------------------------------------------
# Makefile for FINAL CUT
#-----------------------------------------------------------------------------

# This is where make install will install the library
VERSION = "0.7.2"
MAJOR := $(shell echo ${VERSION} | cut -d. -f1)
LIBDIR = /usr/local/lib
INCLUDEDIR1 = .
INCLUDEDIR2 = /usr/local/include/final
INCLUDE_HEADERS = \
	fapplication.h \
	widget/fbuttongroup.h \
	widget/fbutton.h \
	util/fcallback.h \
	util/fdata.h \
	vterm/fcolorpair.h \
	vterm/fstyle.h \
	widget/ftogglebutton.h \
	widget/fcheckbox.h \
	widget/fswitch.h \
	dialog/fdialog.h \
	widget/fwindow.h \
	dialog/ffiledialog.h \
	final.h \
	widget/flabel.h \
	widget/flineedit.h \
	widget/flistbox.h \
	widget/flistview.h \
	util/flog.h \
	util/flogger.h \
	menu/fmenu.h \
	menu/fdialoglistmenu.h \
	menu/fmenubar.h \
	menu/fradiomenuitem.h \
	menu/fcheckmenuitem.h \
	dialog/fmessagebox.h \
	widget/ftooltip.h \
	widget/fbusyindicator.h \
	output/tty/sgr_optimizer.h \
	output/tty/foptiattr.h \
	output/tty/foptimove.h \
	vterm/ftermbuffer.h \
	util/fpoint.h \
	util/fsize.h \
	widget/fprogressbar.h \
	widget/fradiobutton.h \
	util/frect.h \
	util/fsystem.h \
	util/fsystemimpl.h \
	widget/fscrollbar.h \
	widget/fscrollview.h \
	widget/fspinbox.h \
	widget/fcombobox.h \
	widget/fstatusbar.h \
	util/fstring.h \
	util/fstringstream.h \
	input/fmouse.h \
	input/fkeyboard.h \
	fstartoptions.h \
	output/tty/ftermcap.h \
	output/tty/fterm.h \
	output/tty/fterm_functions.h \
	output/tty/ftermdata.h \
	output/tty/ftermdebugdata.h \
	output/foutput.h \
	output/tty/ftermoutput.h \
	output/tty/ftermios.h \
	output/tty/ftermdetection.h \
	output/tty/ftermcapquirks.h \
	output/tty/ftermxterminal.h \
	output/tty/ftermfreebsd.h \
	output/tty/ftermopenbsd.h \
	output/tty/ftermlinux.h \
	vterm/fvterm.h \
	widget/ftextview.h \
	output/fcolorpalette.h \
	fwidgetcolors.h \
	fwidget_functions.h \
	fwidget.h \
	fevent.h \
	fobject.h

# compiler parameter
CXX = clang++
CCXFLAGS = $(OPTIMIZE) $(PROFILE) -DCOMPILE_FINAL_CUT $(DEBUG) $(VER) $(GPM) -fexceptions -std=c++11
MAKEFILE = -f Makefile.clang
LDFLAGS = $(TERMCAP) -lgpm
INCLUDES = -I..
GPM = -D F_HAVE_LIBGPM
VER = -D F_VERSION=$(VERSION)
RM = rm -f
LIB = libfinal.so
OBJS = \
	dialog/fdialog.o \
	dialog/fmessagebox.o \
	dialog/ffiledialog.o \
	input/fmouse.o \
	input/fkeyboard.o \
	input/fkey_map.o \
	menu/fmenu.o \
	menu/fdialoglistmenu.o \
	menu/fmenubar.o \
	menu/fmenuitem.o \
	menu/fradiomenuitem.o \
	menu/fcheckmenuitem.o \
	menu/fmenulist.o \
	util/fstring.o \
	util/fstringstream.o \
	util/fpoint.o \
	util/fsize.o \
	util/frect.o \
	util/fcallback.o \
	util/fdata.o \
	util/flog.o \
	util/flogger.o \
	util/fsystem.o \
	util/fsystemimpl.o \
	widget/fscrollbar.o \
	widget/fprogressbar.o \
	widget/flineedit.o \
	widget/fbutton.o \
	widget/fbuttongroup.o \
	widget/ftogglebutton.o \
	widget/fradiobutton.o \
	widget/fcheckbox.o \
	widget/fswitch.o \
	widget/flabel.o \
	widget/flistbox.o \
	widget/flistview.o \
	widget/fwindow.o \
	widget/fscrollview.o \
	widget/fspinbox.o \
	widget/fcombobox.o \
	widget/ftooltip.o \
	widget/fbusyindicator.o \
	widget/ftextview.o \
	widget/fstatusbar.o \
	vterm/fvterm.o \
	vterm/ftermbuffer.o \
	output/tty/ftermcap.o \
	output/tty/fcharmap.o \
	output/tty/fterm.o \
	output/tty/fterm_functions.o \
	output/tty/ftermdebugdata.o \
	output/foutput.o \
	output/tty/ftermoutput.o \
	output/tty/ftermios.o \
	output/tty/ftermdetection.o \
	output/tty/ftermcapquirks.o \
	output/tty/ftermxterminal.o \
	output/tty/ftermfreebsd.o \
	output/tty/ftermopenbsd.o \
	output/tty/ftermlinux.o \
	output/fcolorpalette.o \
	output/tty/sgr_optimizer.o \
	output/tty/foptiattr.o \
	output/tty/foptimove.o \
	fstartoptions.o \
	fapplication.o \
	fwidgetcolors.o \
	fwidget.o \
	fwidget_functions.o \
	fevent.o \
	fobject.o

TERMCAP := $(shell test -n "$$(ldd {/usr,}/lib64/libncursesw.so.5 2>/dev/null | grep libtinfo)" && echo "-ltinfo" || echo "-lncurses")

ifdef DEBUG
  OPTIMIZE = -O0 -fsanitize=undefined
else
  OPTIMIZE = -O2
endif

.SUFFIXES: .cpp

# $@ = name of the targets
# $< = the first dependency
.cpp.o:
	$(CXX) -c $(CCXFLAGS) $(INCLUDES) -fpic -o $@ $<

all: dep $(OBJS)
	$(CXX) $(OBJS) -o $(LIB).$(VERSION) $(CCXFLAGS) $(INCLUDES) $(LDFLAGS) -shared -Wl,-soname,$(LIB).$(MAJOR)
	ln -s -f $(LIB).$(VERSION) libfinal.so.$(MAJOR)
	ln -s -f $(LIB).$(MAJOR) libfinal.so

$(LIB): all

debug:
	$(MAKE) $(MAKEFILE) DEBUG="-g -D DEBUG -Wall -Wextra -Wpedantic -Weverything -Wno-padded -Wno-c++98-compat -Wno-c++98-compat-pedantic -Wno-implicit-fallthrough -Wno-reserved-id-macro -Wno-format-nonliteral -Wno-switch-enum -Wno-covered-switch-default"

unittest:
	$(MAKE) $(MAKEFILE) DEBUG="-g -D DEBUG -DUNIT_TEST -Wall -Wextra -Wpedantic -Weverything -Wno-padded -Wno-c++98-compat -Wno-c++98-compat-pedantic -Wno-implicit-fallthrough -Wno-reserved-id-macro -Wno-format-nonliteral -Wno-switch-enum -Wno-covered-switch-default"

profile:
	$(MAKE) $(MAKEFILE) PROFILE="-pg"

install: $(LIB)
	mkdir -p $(LIBDIR)
	install -c $(LIB).$(VERSION) $(LIBDIR)/$(LIB).$(VERSION)
	ln -s -f $(LIB).$(VERSION) $(LIBDIR)/libfinal.so.$(MAJOR)
	ln -s -f $(LIB).$(MAJOR) $(LIBDIR)/libfinal.so
	ldconfig
	mkdir -p $(INCLUDEDIR2)
	for d in dialog input menu output output/tty util vterm widget; \
        do \
	  mkdir -p $(INCLUDEDIR2)/$$d; \
	done
	@list='$(INCLUDE_HEADERS)'; for h in $$list; \
	do \
	  install -m 644 $(INCLUDEDIR1)/$$h $(INCLUDEDIR2)/$$h; \
	done

uninstall: $(OBJS)
	$(RM) $(LIBDIR)/$(LIB).$(VERSION) $(LIBDIR)/libfinal.so.$(MAJOR) $(LIBDIR)/libfinal.so
	@list='$(INCLUDE_HEADERS)'; for h in $$list; \
	do \
	  $(RM) $(INCLUDEDIR2)/$$h; \
	done
	for d in widget vterm util output/tty output menu input dialog; \
        do \
	  rmdir $(INCLUDEDIR2)/$$d; \
	done
	rmdir $(INCLUDEDIR2)

.PHONY: clean dep
clean:
	$(RM) $(LIB)* $(OBJS) .depend *.gcno *.gcda *.gch *.plist *~

dep:
	$(CXX) $(INCLUDES) -std=c++11 -DCOMPILE_FINAL_CUT -MM *.cpp >.depend

#
# include .depend if it exists
#

-include .depend
